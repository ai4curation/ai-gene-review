name: ARBA Issue Monitor

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - only report found ARBAs without reviewing'
        required: false
        default: 'false'
        type: boolean
      max_issues:
        description: 'Maximum number of issues to scan'
        required: false
        default: '50'
        type: string

jobs:
  scan-arba-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      arba_ids: ${{ steps.search_issues.outputs.arba_ids }}
      has_arbas: ${{ steps.search_issues.outputs.has_arbas }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install just
        run: |
          uv tool install rust-just
          uv sync

      - name: Search for ARBA mentions in go-annotation issues
        id: search_issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run scripts/scan_arba_issues.py --max-issues ${{ inputs.max_issues || '50' }} --output github

  claude-arba-review:
    needs: scan-arba-issues
    if: needs.scan-arba-issues.outputs.has_arbas == 'true' && inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install just
        run: |
          uv tool install rust-just
          uv sync

      - name: Run Claude ARBA Review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent

          direct_prompt: |
            You are reviewing ARBA rules that were mentioned in the geneontology/go-annotation issue tracker.
            This indicates GO curators have raised concerns or questions about these rules.

            ARBA IDs to consider reviewing: ${{ needs.scan-arba-issues.outputs.arba_ids }}

            ## Your Task

            Pick a SINGLE unreviewed ARBA ID from the list above and review it.
            Review files are stored in `rules/arba/{ARBA_ID}/{ARBA_ID}-review.yaml`.
            if ALL of the IDs above are accounted for, you can end this task here.
            Otherwise, pick a single ID from the list above and review it.

            You must NOT pick an ID that is either reviewed already, or for which there is
            an existing PR. PRs can be checked:

            ```
            gh pr list -L 100 --search "ARBA"
            ```
            
            To analyze the rule, you MUST use the rule-reviewer subagent.

            You must utilize AT LEAST ONE deep research result in your analysis. This DOES NOT include
            doing your own research. You MUST utilize one of perplexity, cyberian, or falcon. If you
            are unable to do this STOP ALL WORK AND FAIL WITH AN ERROR, and an administrator will fix this.
            
            When you are done, create a new PR in this repo with the changes to the rule.
            Include in the PR any additional references that were cached too.

            Summarize your findings in the PR description. Also search https://github.com/geneontology/go-annotation/issues
            for mentions of this ARBA ID, and link to the go-annotation issue in the PR description.

          allowed_tools: "Read,Write,Edit,Glob,Grep,Bash,WebFetch,WebSearch,Task"
